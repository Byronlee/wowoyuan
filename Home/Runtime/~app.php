<?php  function getUserName($uid,$lang='zh') { if ($uid){ $uModel = new Model(); $uname = $uModel->query("SELECT username FROM wo_user WHERE user_id = $uid"); return $uname[0]['username']; } else return '用户不存在!'; } function showRed($string,$keyword){ $replace = "<font color='red'>$keyword</font>"; return preg_replace("/$keyword/",$replace,$string); } function getShort($str, $length = 40, $ext = '') { $str = htmlspecialchars($str); $str = strip_tags($str); $str = htmlspecialchars_decode($str); $strlenth = 0; $out = ''; preg_match_all("/[\x01-\x7f]|[\xc2-\xdf][\x80-\xbf]|[\xe0-\xef][\x80-\xbf]{2}|[\xf0-\xff][\x80-\xbf]{3}/", $str, $match); foreach($match[0] as $v){ preg_match("/[\xe0-\xef][\x80-\xbf]{2}/",$v, $matchs); if(!empty($matchs[0])){ $strlenth += 1; }elseif(is_numeric($v)){ $strlenth += 0.545; }else{ $strlenth += 0.475; } if ($strlenth > $length) { $output .= $ext; break; } $output .= $v; } return $output; } function getImageById($id){ if (!isset($id)) return 0; $imgName = D()->query('SELECT img_name From wo_goods_img WHERE img_id = '.$id); if ($imgName) return $imgName[0]['img_name']; } function getList($first,$second){ $info=M('shelve')->where("class_first=$first AND class_second=$second AND is_Sale=2")->order('goods_id DESC')->limit('5')->findAll(); if (!empty($info)) return $info; } function real_ip(){ static $realip = NULL; if ($realip !== NULL){ return $realip; } if (isset($_SERVER)){ if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])){ $arr = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']); foreach ($arr as $ip){ $ip = trim($ip); if ($ip != 'unknown'){ $realip = $ip; break; } } }elseif (isset($_SERVER['HTTP_CLIENT_IP'])){ $realip = $_SERVER['HTTP_CLIENT_IP']; } else { if (isset($_SERVER['REMOTE_ADDR'])){ $realip = $_SERVER['REMOTE_ADDR']; }else { $realip = '0.0.0.0'; } } } else { if (getenv('HTTP_X_FORWARDED_FOR')){ $realip = getenv('HTTP_X_FORWARDED_FOR'); } elseif (getenv('HTTP_CLIENT_IP')){ $realip = getenv('HTTP_CLIENT_IP'); } else { $realip = getenv('REMOTE_ADDR'); } } preg_match("/[\d\.]{7,15}/", $realip, $onlineip); $realip = !empty($onlineip[0]) ? $onlineip[0] : '0.0.0.0'; return $realip; } function getMenu($type){ $i = 0; $menu = array(); if ($type=='trade'){ $first = D()->query('SELECT class_first_name,class_first_id FROM wo_goods_class_first'); $second = D()->query('SELECT class_second_name,class_first_id FROM wo_goods_class_second'); } else { $first = D()->query('SELECT forum_class_first_name,forum_class_first_id FROM wo_forum_class_first'); $second = D()->query('SELECT forum_class_second_name,forum_class_second_id FROM wo_forum_class_second'); } dump($first); dump($second); foreach ($first as $key =>$value ){ foreach ($second as $keys => $values){ if($value['forum_class_first_id'] ==$values['forum_class_first_id']){ $menu[$value['forum_class_first_name']][$i++] = $values['forum_class_second_name']; } else $i=0; } } return $menu; } function getUserFace($uid,$size){ $size = ($size) ? $size : 'm'; if ($size == 'm') { $type = 'middle'; } elseif ($size == 's') { $type = 'small'; } else { $type = 'big'; } $faceurl ='Public/images/uploads/avatar/'.$uid.'/'.$type.'.jpg'; if (is_file($faceurl)) { return "/".$faceurl; } else { return "/Public/images/uploads/avatar/default/default_".$type.".gif"; } } function getUserSpace($uid, $text,$at=FALSE) { static $_userinfo = array (); $ui=$uid*3762-37; $ui_=md5($ui); if (! isset ( $_userinfo [$uid] )) { $_userinfo [$uid] = D ( 'User', 'home' )->getUserByIdentifier ( $uid, 'uid' ); } $title=getUserName($uid); $target = '_blank'; if ($text=='uname') { if ($at){ $text = getUserName($uid); $text='@'.$text; $class = 'username'; }else{ $text = getUserName($uid); $class = 'username'; } } if($text=='uvatar') { $face = getUserFace($uid,$text); $text = "<img src=\"$face\"/>"; $class = 'avatar'; } if ($_userinfo [$uid] ['domain']) $url = U ( 'Space/index', array ('uid' => $_userinfo [$uid] ['domain'], 'ui_'=>$ui_) ); else $url = U ( 'Space/index', array ('uid' => $uid, 'ui_'=>$ui_ ) ); return "<a href='{$url}' class='{$class}' title='{$title}' target='{$target}'>$text</a>"; } function setOnline($uid) { $cookie_name = 'login_time_' . $uid; $cookie_time = intval(cookie($cookie_name)); $now = time(); $expire = 5 * 60; if ($cookie_time < ($now - $expire)) { cookie($cookie_name, $now, $expire); $sql = 'REPLACE INTO ' . C('DB_PREFIX') . 'user_online (user_id,record_time) VALUES ("' . $uid . '", "' . $now . '")'; return M('')->query($sql); } else { return null; } } function format($content) { $content = preg_replace_callback ( "/(?:#[^#]*[^#^\s][^#]*#|(\[.+?\]))/is", replaceEmot, $content ); $content = preg_replace_callback("/@([\w\x{4e00}-\x{9fa5}\-]+)/u",getUserId,$content); $content = preg_replace('/((?:https?|mailto):\/\/(?:www\.)?(?:[a-zA-Z0-9][a-zA-Z0-9\-]*\.)?[a-zA-Z0-9][a-zA-Z0-9\-]*(?:\.[a-zA-Z0-9]+)+(?:\:[0-9]*)?(?:\/[^\x{4e00}-\x{9fa5}\s<\'\"“”‘’]*)?)/u', '<a href="\1" target="_blank">http://wowoyuan.com/3qAQ4&nbsp;</a>', $content); return $content; } function getUserId($name) { $info = D('User', 'home')->getUserByIdentifier($name[1], 'uname'); if ($info) { return getUserSpace($info['user_id'],'uname',true); }else { return "<a href=".U('Index/s_result').">".$name[0]."</a>"; } } function replaceEmot($data) { if(preg_match("/#.+#/i",$data[0])) { return $data[0]; } $info = getExpressionDetailByEmotion($data[1]); if($info) { return preg_replace("/\[.+?\]/i","<img src='".__PUBLIC__."/images/expression/".$info['filename']."' />",$data[0]); }else { return $data[0]; } } function getExpressionDetailByEmotion($emotion){ $list = array(); $res = D('Expression')->field('title,emotion,filename,type')->findAll(); foreach ($res as $v) { $list[$v['emotion']] = $v; } return $list[$emotion]; } function friendlyDate($sTime, $type = 'normal', $alt = 'false') { $cTime = time (); $dTime = $cTime - $sTime; $dDay = $dTime / 3600 / 24; $dYear = intval ( date ( "Y", $cTime ) ) - intval ( date ( "Y", $sTime ) ); if ($type == 'normal') { if ($dTime < 60) { return $dTime . "秒前"; } elseif ($dTime < 3600) { return intval ( $dTime / 60 ) . "分钟前"; } elseif ($dTime >= 3600 && $dDay == 0) { return '今天' . date ( 'H:i', $sTime ); } elseif ($dYear == 0) { return date ( "m月d日 H:i", $sTime ); } else { return date ( "Y-m-d H:i", $sTime ); } } elseif ($type == 'mohu') { if ($dTime < 60) { return $dTime . "秒前"; } elseif ($dTime < 3600) { return intval ( $dTime / 60 ) . "分钟前"; } elseif ($dTime >= 3600 && $dDay == 0) { return intval ( $dTime / 3600 ) . "小时前"; } elseif ($dDay > 0 && $dDay <= 7) { return intval ( $dDay ) . "天前"; } elseif ($dDay > 7 && $dDay <= 30) { return ceil ( $dDay / 7 ) . '周前'; } elseif ($dDay > 30) { return ceil ( $dDay / 30 ) . '个月前'; } } elseif ($type == 'full') { return date ( "Y-m-d , H:i:s", $sTime ); } elseif ($type == 'ymd') { return date ( "Y-m-d", $sTime ); } else { if ($dTime < 60) { return $dTime . "秒前"; } elseif ($dTime < 3600) { return intval ( $dTime / 60 ) . "分钟前"; } elseif ($dTime >= 3600 && $dDay == 0) { return intval ( $dTime / 3600 ) . "小时前"; } elseif ($dYear == 0) { return date ( "Y-m-d H:i:s", $sTime ); } else { return date ( "Y-m-d H:i:s", $sTime ); } } } function getfollower_num($uid){ $count ['follower'] = M ( 'Flash' )->where ( "fid=$uid AND type=0" )->count (); return "1200"; } function getfollowering_num($uid){ $count ['following'] = M ( 'Flash' )->where ( "uid=$uid AND type=0" )->count (); return "120"; } function getflash_num($uid){ M ( 'Flash' )->where ( 'user_id=' . $uid )->count (); return "67"; } function getMini_num($uid){ M ( 'Flash' )->where ( 'user_id=' . $uid )->count (); return "467"; } function getFollowState($uid,$fid) { if (M('user_follow')->where("(uid=$uid AND fid=$fid) OR (uid=$fid AND fid=$uid)")->count() == 2) { return 'eachfollow'; }else if(M('user_follow')->where("uid=$uid AND fid=$fid ")->count()) { return 'havefollow'; }else { return 'unfollow'; } } function isValidEmail($email){ return preg_match("/[_a-zA-Z\d\-\.]+@[_a-zA-Z\d\-]+(\.[_a-zA-Z\d\-]+)+$/i", $email) !== 0; } function h($text, $tags ='1'){ $text = preg_replace('/<!--?.*-->/','',$text); $text = preg_replace('/<!--?.*-->/','',$text); $text = preg_replace('/<\?|\?'.'>/','',$text); $text = preg_replace('/<script?.*\/script>/','',$text); while(preg_match('/(<[^><]+) (lang|on|action|background|codebase|dynsrc|lowsrc)[^><]+/i',$text,$mat)){ $text=str_replace($mat[0],$mat[1],$text); } while(preg_match('/(<[^><]+)(window\.|javascript:|js:|about:|file:|document\.|vbs:|cookie)([^><]*)/i',$text,$mat)){ $text=str_replace($mat[0],$mat[1].$mat[3],$text); } $text = str_replace('  ',' ',$text); return $text; } function t($text, $parse_br = false, $quote_style = ENT_NOQUOTES) { if (is_numeric($text)) $text = (string)$text; if (!is_string($text)) return null; if (!$parse_br) { $text = str_replace(array("\r","\n","\t"), ' ', $text); } else { $text = nl2br($text); } $text = stripslashes($text); $text = htmlspecialchars($text, $quote_style, 'UTF-8'); return $text; } function md($id){ $ui=$id*3762-37; $ui_=md5($ui); return $ui_; } return array ( 'app_debug' => '', 'app_domain_deploy' => false, 'app_sub_domain_deploy' => false, 'app_plugin_on' => false, 'app_file_case' => false, 'app_group_depr' => '.', 'app_group_list' => '', 'app_autoload_reg' => false, 'app_autoload_path' => 'Think.Util.', 'app_config_list' => array ( 0 => 'taglibs', 1 => 'routes', 2 => 'tags', 3 => 'htmls', 4 => 'modules', 5 => 'actions', ), 'cookie_expire' => 3600, 'cookie_domain' => '', 'cookie_path' => '/', 'cookie_prefix' => '', 'default_app' => '@', 'default_group' => 'Home', 'default_module' => 'public', 'default_action' => 'index', 'default_charset' => 'utf-8', 'default_timezone' => 'PRC', 'default_ajax_return' => 'JSON', 'default_theme' => 'default', 'default_lang' => 'zh-cn', 'db_type' => 'mysql', 'db_host' => 'localhost', 'db_name' => 'wowoyuan', 'db_user' => 'root', 'db_pwd' => '', 'db_port' => 3306, 'db_prefix' => 'wo_', 'db_suffix' => '', 'db_fieldtype_check' => false, 'db_fields_cache' => true, 'db_charset' => 'utf8', 'db_deploy_type' => 0, 'db_rw_separate' => false, 'data_cache_time' => -1, 'data_cache_compress' => false, 'data_cache_check' => false, 'data_cache_type' => 'File', 'data_cache_path' => 'Home/Runtime/Temp/', 'data_cache_subdir' => false, 'data_path_level' => 1, 'error_message' => '您浏览的页面暂时发生了错误！请稍后再试～', 'error_page' => '', 'html_cache_on' => false, 'html_cache_time' => 60, 'html_read_type' => 0, 'html_file_suffix' => '.shtml', 'lang_switch_on' => false, 'lang_auto_detect' => true, 'log_exception_record' => true, 'log_record' => false, 'log_file_size' => 2097152, 'log_record_level' => array ( 0 => 'EMERG', 1 => 'ALERT', 2 => 'CRIT', 3 => 'ERR', ), 'page_rollpage' => 5, 'page_listrows' => 20, 'session_auto_start' => true, 'show_run_time' => true, 'show_adv_time' => true, 'show_db_times' => true, 'show_cache_times' => true, 'show_use_mem' => true, 'show_page_trace' => false, 'show_error_msg' => true, 'tmpl_engine_type' => 'Think', 'tmpl_detect_theme' => false, 'tmpl_template_suffix' => '.html', 'tmpl_content_type' => 'text/html', 'tmpl_cachfile_suffix' => '.php', 'tmpl_deny_func_list' => 'echo,exit', 'tmpl_parse_string' => '', 'tmpl_l_delim' => '{', 'tmpl_r_delim' => '}', 'tmpl_var_identify' => 'array', 'tmpl_strip_space' => false, 'tmpl_cache_on' => true, 'tmpl_cache_time' => -1, 'tmpl_action_error' => 'Public:success', 'tmpl_action_success' => 'Public:success', 'tmpl_trace_file' => 'F:\\wamp\\www\\ThinkPHP/Tpl/PageTrace.tpl.php', 'tmpl_exception_file' => 'F:\\wamp\\www\\ThinkPHP/Tpl/ThinkException.tpl.php', 'tmpl_file_depr' => '/', 'taglib_begin' => '<', 'taglib_end' => '>', 'taglib_load' => true, 'taglib_build_in' => 'cx', 'taglib_pre_load' => '', 'tag_nested_level' => 3, 'tag_extend_parse' => '', 'token_on' => true, 'token_name' => '__hash__', 'token_type' => 'md5', 'url_case_insensitive' => false, 'url_router_on' => true, 'url_route_rules' => array ( ), 'url_model' => 1, 'url_pathinfo_model' => 2, 'url_pathinfo_depr' => '/', 'url_html_suffix' => '', 'var_group' => 'g', 'var_module' => 'm', 'var_action' => 'a', 'var_router' => 'r', 'var_page' => 'p', 'var_template' => 't', 'var_language' => 'l', 'var_ajax_submit' => 'ajax', 'var_pathinfo' => 's', 'user_auth_on' => true, 'user_auth_type' => 2, 'user_auth_key' => 'id', 'admin_auth_key' => 'administrator', 'user_auth_model' => 'user', 'auth_pwd_encoder' => 'md5', 'user_auth_gateway' => '/Public/index', 'not_auth_module' => 'Public', 'require_auth_module' => '', 'not_auth_action' => 'index', 'require_auth_action' => '', 'guest_auth_on' => false, 'guest_auth_id' => 0, 'db_like_fields' => 'title|remark', 'rbac_role_table' => 'wowoyuan_role', 'rbac_user_table' => 'wowoyuan_role_user', 'rbac_access_table' => 'wowoyuan_access', 'rbac_node_table' => 'wowoyuan_node', '_routes_' => array ( 0 => array ( 0 => 'Reg', 1 => 'Public/register', 2 => '', 3 => '', ), 1 => array ( 0 => 'login', 1 => 'Public/index', 2 => '', 3 => '', ), 2 => array ( 0 => 'url=login', 1 => '/Public/index', 2 => '', 3 => '', ), 3 => array ( 0 => '', 1 => '/Public/index', 2 => '', 3 => '', ), 4 => array ( 0 => 'uphead', 1 => 'Public/upload_head', 2 => '', 3 => '', ), 5 => array ( 0 => 'url=flash', 1 => 'ShanCun/index', 2 => '', 3 => '', ), 6 => array ( 0 => 'url=forum', 1 => 'Forum/index', 2 => '', 3 => '', ), 7 => array ( 0 => 'url=trade', 1 => 'Trade/index', 2 => '', 3 => '', ), 8 => array ( 0 => 'sorry', 1 => 'Public/checkout', 2 => '', 3 => '', ), 9 => array ( 0 => 'forgetpw', 1 => 'Public/forgetpw', 2 => '', 3 => '', ), 10 => array ( 0 => 'experience', 1 => 'Public/new_user', 2 => '', 3 => '', ), 11 => array ( 0 => 'out', 1 => 'Public/loginout', 2 => '', 3 => '', ), 12 => array ( 0 => 'error', 1 => 'Public/error', 2 => '', 3 => '', ), 13 => array ( 0 => 'url=home', 1 => 'Index/home', 2 => '', 3 => '', ), ), ); ?>